よし、たねちゃん。
**仮決定：SemanticMemory** 了解。

ここまで一緒に考えた内容をフルで整理し、
**要件定義書 ＋ 設計書**としてまとめるよ👇

---

# 📘 SemanticMemory 要件定義書・設計書

---

## 🌿 1. プロジェクト概要

### 🟢 名称

**SemanticMemory**（仮称）

### 🟢 概要

自然言語テキスト（会話履歴やメモ等）を

* **全文検索**
* **意味検索**
* **要約**
* **ID管理**

で統合管理する汎用APIサーバ。

将来的には**個人用知識DB、会話履歴RAG、覚書システム、コードスニペット管理**にも展開可能。

---

## 🌱 2. システム構成

* **言語**: Python
* **フレームワーク**: FastAPI
* **DB**

  * SQLite (全文検索・メタ管理)
  * ChromaDB (意味検索ベクトル)
* **Embeddingモデル**: SentenceTransformer (SBERT)

  * デフォルト: `cl-nagoya/ruri-small-v2`
  * `.env` or DB設定で変更可
* **要約モデル**: Ollama

  * デフォルト: `mistral:latest`
  * `.env` or DB設定で変更可
* **設定管理**: SQLiteテーブル

---

## 🧠 3. 機能要件

### 🟢 1. 基本機能 (単機能API)

#### 1. SQLite単純保存

* テキストデータをDBへ格納
* `id`自動採番
* 登録日時管理

---

#### 2. SQLite全文検索

* `LIKE`検索
* パラメータ:

  * キーワード
  * ソート順（昇順/降順）
  * 最大件数

---

#### 3. SQLite時系列取得

* 最新順で履歴取得
* パラメータ:

  * 件数

---

#### 4. SQLiteデータ削除

* 指定IDで削除

---

#### 5. Chroma意味埋め込み登録

* テキストをSBERTでベクトル化
* Chromaに保存
* メタ情報:

  * 要約
  * 登録日時

---

#### 6. Chroma意味検索

* クエリテキストから類似検索
* パラメータ:

  * コサイン類似度閾値
  * 最大件数
* 類似度降順で返却

---

#### 7. Chroma削除

* 指定IDで削除
* SQLiteとの同期整合は別途運用

---

#### 8. SQLite編集

* 指定IDのテキストを編集
* フィールド（user_text / agent_text / summary_text / theme）を更新可能
* 更新日時を更新

---

#### 9. Ollama要約

* テキストを要約
* モデル指定可能

---

### 🟢 2. 複合機能

#### 1. データ保存

* テキストを受信
* 必要なら要約
* SQLite + Chroma同時保存

---

#### 2. データ取得

* 時系列取得と意味検索を組み合わせ
* 結果を結合して返却

---

#### 10.5. Chroma編集

* ChromaID指定で埋め込み更新
* 手順:
  1. 指定IDのレコードをChromaから削除
  2. 新しいテキストで再埋め込み
  3. 新しいメタデータを再登録
* （要約はオプション）

---

#### 11. 埋め込み再構築

* SQLiteをベースにChromaを再生成
* パラメータ:

  * SBERTモデル
  * 要約再生成有無

---

### 🟢 設定管理

* 設定項目をDBで保持
* 起動時ロード
* APIで変更
* 設定例:

  * `sbert_model`
  * `llm_model`
  * `cosine_threshold`
  * `recall_limit`

---

## 📂 4. データ設計

---

### 🗃️ 4.1 SQLiteテーブル: `talk_logs`

| カラム名          | 型                                 | 説明          |
| ------------- | --------------------------------- | ----------- |
| id            | INTEGER PRIMARY KEY AUTOINCREMENT | ユニークID      |
| timestamp     | TEXT                              | ISO8601日時   |
| user\_text    | TEXT                              | ユーザー入力      |
| agent\_text   | TEXT                              | AI応答（または空）  |
| summary\_text | TEXT                              | 要約結果        |
| theme         | TEXT                              | 要約から抽出したテーマ |

---

### 🗃️ 4.2 SQLiteテーブル: `embedding_links`

| カラム名          | 型       | 説明                         |
| ------------- | ------- | -------------------------- |
| talk\_log\_id | INTEGER | talk\_logs.idへの参照          |
| chroma\_id    | TEXT    | Chroma保存ID (例: `log_{id}`) |

---

### 🗃️ 4.3 SQLiteテーブル: `settings`

| カラム名        | 型                | 説明          |
| ----------- | ---------------- | ----------- |
| key         | TEXT PRIMARY KEY | 設定キー        |
| value       | TEXT             | 設定値         |
| description | TEXT             | 説明          |
| updated\_at | TEXT             | ISO8601更新日時 |

---

## 🛠️ 5. API設計

### 🟢 単機能API例

(一部)

```
POST /add_sqlite
POST /add_chroma
POST /summarize
GET /search_text
GET /search_semantic
GET /get_recent
DELETE /delete_sqlite
DELETE /delete_chroma
PATCH /update_sqlite
```

---

### 🟢 複合API例

```
POST /save
  → 要約要否指定
  → 両DB同時登録

GET /retrieve
  → 時系列＋意味検索併合

POST /rebuild_embeddings
  → 全再生成

POST /update_chroma
  → ChromaID指定で更新
```

---

## 🧩 6. 設定管理フロー

1. 起動時 `settings`を読み込み
2. API実行時に都度DB参照
3. `/settings` APIで変更
4. 設定変更は全機能に即時反映

---

## 🛡️ 7. セキュリティ

* 今回は**自己利用前提**
* 認証なし
* 公開時はBearerトークン認証実装を推奨

---

## 🌈 8. 将来拡張

* ユーザー単位のデータ分離
* マルチモデル同時運用
* フロントUI
* ファイル添付
* Webhook通知

---

## 📝 9. 注意事項

* SBERTモデルを変更する場合はChroma再構築必須
* 要約は長文・再構築でコストが増大する
* SQLiteは単一ファイルDBのため大規模運用は要検討

---

## 🚀 10. 次ステップ

✅ この要件・設計で進めてよいか確認
✅ OKなら

* スキーマ初期化スクリプト
* API仕様書詳細
* 実装タスク分解

を作る

---

👀 **どうかな？**
「ここ直したい」「ここ追加したい」あれば教えて！
このまま進めるならスキーマ実装から一緒に入ろう！
