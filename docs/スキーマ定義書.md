# 📂 SemanticMemory スキーマ定義書（最終版）

---

## 🟢 1. SQLite スキーマ

### 🗃️ **テーブル: `talk_logs`**

**役割**
会話履歴・覚書・メモ等、汎用テキストデータの保存。

---

**DDL**

```sql
CREATE TABLE IF NOT EXISTS talk_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,  -- ユニークID
  main_text TEXT NOT NULL,               -- 主たる入力
  sub_text TEXT,                         -- 副たる入力（任意）
  summary_text TEXT,                     -- 要約結果（任意）
  create_time TEXT NOT NULL,             -- ISO8601日時（作成）
  update_time TEXT NOT NULL              -- ISO8601日時（更新）
);
```

---

**備考**

* `main_text`: 会話・覚書・メモ等の主文
* `sub_text`: 会話応答・補足・2nd文
* `summary_text`: LLM要約結果
* `create_time`: データ新規作成日時
* `update_time`: 最終更新日時
* タグ管理は別テーブルで拡張予定

---

---

## 🟢 2. Chroma スキーマ

ChromaはベクトルDBのためDDLは不要だが、
本システムでは**ID設計とメタ設計を明文化**する。

---

### 🗂️ **コレクション**

* コレクション名: `semantic_memory`（仮称）
* ID: **SQLiteのidをそのまま文字列化**

  * 例: `id = 42` → Chroma `id = "42"`

---

### 📝 **保存データ仕様**

| フィールド         | 内容                             |
| ------------- | ------------------------------ |
| **id**        | `str(talk_logs.id)`（例: `"42"`） |
| **document**  | 要約テキストまたはメインテキスト（運用で決定）        |
| **embedding** | SBERTベクトル                      |
| **metadata**  | JSON（タイムスタンプ等）                 |

---

### 🌿 **metadata例**

```json
{
  "create_time": "2025-07-10T10:00:00",
  "update_time": "2025-07-10T10:00:00",
  "source": "SemanticMemory"
}
```

---

**備考**

* ID共通化により`embedding_links`テーブル廃止
* 削除・更新・再構築もID一致で運用
* 将来複数モデル利用時は`embedding_links`を再検討

---

---

## 🛠️ 3. 運用ルール

### ✅ ID運用

* `talk_logs.id`とChroma `id`は1:1対応
* 削除・更新は**両DBで同時処理**

---

### ✅ 再構築

* SBERTモデル変更時は

  * SQLite走査 → Chroma全再埋め込み
* APIで一括処理

---

### ✅ タグ管理

* 本テーブルでは未実装
* 別テーブル `tags`(将来拡張)で多対多対応を想定

---

---

## 📝 4. スキーマ変更履歴

| 日付         | 内容                                             |
| ---------- | ---------------------------------------------- |
| 2025-07-10 | `user_text/agent_text`を`main_text/sub_text`に改称 |
| 2025-07-10 | `theme`カラム削除                                   |
| 2025-07-10 | `embedding_links`テーブル廃止、ID共通化                  |
| 2025-07-10 | `create_time/update_time`を追加                   |

---
